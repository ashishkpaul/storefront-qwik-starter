# Upstream server for Vendure storefront
upstream buylits_storefront {
    server localhost:3000;  # Adjust to your Vendure storefront's port
}

# Redirect HTTP to HTTPS with www
server {
    listen 80;
    server_name buylits.com www.buylits.com;

    # Serve the ACME challenge files directly
    location ^~ /.well-known/acme-challenge/ {
        default_type "text/plain";
        alias /etc/nginx/ssl/.well-known/acme-challenge/;  # Adjust this path as needed
    }

    # Redirect everything else to HTTPS
    location / {
        return 301 https://www.buylits.com$request_uri;
    }
}

# Redirect HTTPS buylits.com to https://www.buylits.com
server {
    listen 443 ssl;
    server_name buylits.com;

    ssl_certificate /etc/letsencrypt/live/buylits.com/fullchain.pem;  # Adjust path as needed
    ssl_certificate_key /etc/letsencrypt/live/buylits.com/privkey.pem;  # Adjust path as needed
    include /etc/letsencrypt/options-ssl-nginx.conf;  # Security options
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;  # DH parameters

    # Cloudflare IP Address Configuration
    include /etc/nginx/snippets/cloudflare_proxy_ip_address.conf;  # Ensure you have Cloudflare IPs here

    return 301 https://www.buylits.com$request_uri;

    location ^~ /.well-known/acme-challenge/ {
        default_type "text/plain";
        alias /etc/nginx/ssl/.well-known/acme-challenge/;  # Adjust this path as needed
    }
}

# Handle HTTPS www.buylits.com
server {
    listen 443 ssl;
    server_name www.buylits.com;

    access_log /var/log/nginx/buylits-com.access.log;  # Adjust log path as needed
    error_log /var/log/nginx/buylits-com.error.log;  # Adjust log path as needed

    ssl_certificate /etc/letsencrypt/live/buylits.com/fullchain.pem;  # Adjust path as needed
    ssl_certificate_key /etc/letsencrypt/live/buylits.com/privkey.pem;  # Adjust path as needed
    include /etc/letsencrypt/options-ssl-nginx.conf;  # Security options
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;  # DH parameters

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Referrer-Policy "same-origin" always;

    # CORS headers
    add_header 'Access-Control-Allow-Origin' 'https://www.buylits.com' always;  # Adjust as needed
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With, Accept' always;

    client_max_body_size 5M;  # Adjust this value based on your file upload requirements

    # Location for the storefront
    location /dist {
        root /2nd_block/storefront/buylits-storefront;  # Adjust to your actual path
        try_files $uri /index.html;  # Fallback to index.html for SPA routing
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_pass http://buylits_storefront;
    }

    location / {
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_pass http://buylits_storefront;
    }

    # Handle preflight requests for CORS
    if ($request_method = OPTIONS) {
        return 204;
    }
}
